<!DOCTYPE html>
<html>
	<head>
		<title>已发订单</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
		<link href="css/style_home.css" rel="stylesheet" type="text/css" media="all" />
		<link href="css/home_layout.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" />
		<script src="js/jquery-3.3.1.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/msg_share.js"></script>
		<script src="js/jquery.cookie.js"></script>
		<script src="https://cdn.bootcss.com/datatables/1.10.16/js/jquery.dataTables.js"></script>
		<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic" />
		<link href="https://fonts.googleapis.com/css?family=Abril+Fatface" rel="stylesheet" type="text/css" />
		<style>
			.content {
      margin: 50px auto;
      border: 1px solid #ccc;
    }
    .operation {
      margin: 10px;
    }
    .operation>button {
      margin: 10px;
    }
    #books_length {
      float: left;
      margin-left: 20px;
    }
    #books_filter {
      float: right;
      margin-right: 20px;
    }
    #books {
      margin: 5px;
    }
    .center-block {
      display: block;
      margin: auto;
    }
  </style>
	</head>

	<body>
		<div class="banner1">
			<div class="container">
				<center>
					<div class="logo">
						<a href="Owner_main.html">Pass All<span>Logistics Transportation System</span></a>
					</div>
				</center>
				<div class="navigation">
					<nav class="navbar navbar-default">
						<!-- Brand and toggle get grouped for better mobile display -->
						<div class="navbar-header">
							<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
								<span class="sr-only">Toggle navigation</span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
							</button>
						</div>

						<!-- Collect the nav links, forms, and other content for toggling -->
						<div class="collapse navbar-collapse nav-wil" id="bs-example-navbar-collapse-1">
							<nav class="cl-effect-13" id="cl-effect-13">
								<ul class="nav navbar-nav">
									<li><a href="Owner_main.html">主页</a></li>
									<li><a href="Owner_published.html" class="active">已发订单</a></li>
									<li><a href="Owner_accepted.html">已被接单</a></li>
									<li><a href="Owner_transforming.html">正在运输</a></li>
									<li><a href="Owner_information.html">个人资料</a></li>
									<li><a href="Owner_mailus.html">关于我们</a></li>
								</ul>
							</nav>
						</div>
						<!-- /.navbar-collapse -->
					</nav>
				</div>
			</div>
		</div>

		<div class="container2">
			<div class="blog">
				<div class="container">
					<h3 style=" font-family:微软雅黑;"><span>在此页面显示的是您 </span> 已发布的订单 </h3>
					<p class="dolore">您可以进行新增、修改、删除操作</p>
				</div>
				<section class="content">
					<center>
						<div class="btn-group operation">
							<button id="btn_add" type="button" class="btn bg-primary" style="color: black;">
								<span class="glyphicon glyphicon-plus" aria-hidden="frue"></span>新增
							</button>
							<button id="btn_edit" type="button" class="btn bg-success" style="color: black;">
								<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改
							</button>
							<button id="btn_delete" type="button" class="btn bg-danger" style="color: black;">
								<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
							</button>
						</div>
					</center>
					<div class="modal fade" id="addBook" role="dialog">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal">&times;</button>
									<h4 class="modal-title">添加订单</h4>
								</div>
								<div id="addBookModal" class="modal-body">
									<form method="get" role="form" class="form-horizontal" id="subform_order">
										<div class="form-group">
											<label for="Cargoname" class="col-sm-3 control-label">商品名称:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="Cargoname" name="Cargoname" type="text">
											</div>
										</div>
										<div class="form-group">
											<label class="col-sm-3 control-label label-name">货物类型:*</label>
											<div class="col-sm-8">
												<select class="form-control" id="goodstype" name="goodstype">
													<option selected value="木材">木材</option>
													<option value="金属">金属</option>
													<option value="石油">石油</option>
													<option value="食品">食品</option>
													<option value="服饰">服饰</option>
													<option value="煤炭">煤炭</option>
												</select>
											</div>
										</div>
										<div class="form-group">
											<label class="col-sm-3 control-label label-name">起始地:*</label>
											<div class="col-sm-8">
												<select class="form-control" name="startplace" id="startplace">
													<option selected value="北京">北京</option>
													<option value="上海">上海</option>
													<option value="黑龙江">黑龙江</option>
													<option value="苏州">苏州</option>
													<option value="天津">天津</option>
													<option value="内蒙古">内蒙古</option>
													<option value="杭州">杭州</option>
													<option value="广州">广州</option>
													<option value="贵州">贵州</option>
													<option value="浙江">浙江</option>
													<option value="辽宁">辽宁</option>
												</select>
											</div>
										</div>
										<div class="form-group">
											<label class="col-sm-3 control-label label-name">目的地:*</label>
											<div class="col-sm-8">
												<select class="form-control" id="destination" name="destination">
													<option selected value="上海">上海</option>
													<option value="天津">天津</option>
													<option value="河北">河北</option>
													<option value="云南">云南</option>
													<option value="沈阳">沈阳</option>
													<option value="苏州">苏州</option>
													<option value="拉萨">拉萨</option>
													<option value="西藏">西藏</option>
													<option value="沈阳">沈阳</option>
												</select>
											</div>
										</div>
										<div class="form-group">
											<label for="Pay" class="col-sm-3 control-label">价格:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="Pay" name="Pay" type="text" value="0">
											</div>
										</div>
										<div class="form-group">
											<label for="Reqtime" class="col-sm-3 control-label">要求送达时间:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="Reqtime" name="Reqtime" type="date">
											</div>
										</div>
										<div class="form-group">
											<label for="Weight" class="col-sm-3 control-label">重量:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="Weight" name="Weight" type="text">
											</div>
										</div>
									</form>
								</div>
								<div class="modal-footer">
									<div class="center-block" align="center">
										<button id="cancelAdd" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
										<button id="submitorder" type="button" class="btn btn-success" data-dismiss="modal">提交订单</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="modal fade" id="editBookInfo" role="dialog">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal">&times;</button>
									<h4 class="modal-title">修改订单内容</h4>
								</div>
								<div id="editBookModal" class="modal-body">
									<form method="get" role="form" class="form-horizontal" id="subform_change">
										<div class="form-group" style="display: none;">
											<label for="Orderkey" class="col-sm-3 control-label">订单号:*</label>
											<div class="col-sm-8">
												<input class="form-control" name="Orderkey" id="Orderkey" type="text" readonly="true">
											</div>
										</div>
										<div class="form-group">
											<label for="Cargoname" class="col-sm-3 control-label">商品名称:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="editCargoname" name="editCargoname" type="text">
											</div>
										</div>
										<div class="form-group">
											<label class="col-sm-3 control-label label-name">货物类型:*</label>
											<div class="col-sm-8">
												<select class="form-control" id="editgoodstype" name="editgoodstype">
													<option selected value="木材">木材</option>
													<option value="金属">金属</option>
													<option value="石油">石油</option>
													<option value="食品">食品</option>
													<option value="服饰">服饰</option>
													<option value="煤炭">煤炭</option>
												</select>
											</div>
										</div>
										<div class="form-group">
											<label class="col-sm-3 control-label label-name">起始地:*</label>
											<div class="col-sm-8">
												<select class="form-control" name="editstartplace" id="editstartplace">
													<option selected value="北京">北京</option>
													<option value="上海">上海</option>
													<option value="黑龙江">黑龙江</option>
													<option value="苏州">苏州</option>
													<option value="天津">天津</option>
													<option value="内蒙古">内蒙古</option>
													<option value="杭州">杭州</option>
													<option value="广州">广州</option>
													<option value="贵州">贵州</option>
													<option value="浙江">浙江</option>
													<option value="辽宁">辽宁</option>
												</select>
											</div>
										</div>
										<div class="form-group">
											<label class="col-sm-3 control-label label-name">目的地:*</label>
											<div class="col-sm-8">
												<select class="form-control" id="editdestination" name="editdestination">
													<option selected value="上海">上海</option>
													<option value="天津">天津</option>
													<option value="河北">河北</option>
													<option value="云南">云南</option>
													<option value="沈阳">沈阳</option>
													<option value="苏州">苏州</option>
													<option value="拉萨">拉萨</option>
													<option value="西藏">西藏</option>
													<option value="沈阳">沈阳</option>
												</select>
											</div>
										</div>
										<div class="form-group">
											<label for="Pay" class="col-sm-3 control-label">价格:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="editPay" name="editPay" type="text" value="0">
											</div>
										</div>
										<div class="form-group">
											<label for="Reqtime" class="col-sm-3 control-label">要求送达时间:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="editReqtime" name="editReqtime" type="date">
											</div>
										</div>
										<div class="form-group">
											<label for="Weight" class="col-sm-3 control-label">重量:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="editWeight" name="editWeight" type="text">
											</div>
										</div>
										<div class="form-group" style="display: none;">
											<label for="Weight" class="col-sm-3 control-label">审核状态:*</label>
											<div class="col-sm-8">
												<input class="form-control" id="editaduit" name="editaduit" type="text">
											</div>
										</div>
									</form>
								</div>
								<div class="modal-footer">
									<div class="center-block" align="center">
										<button id="cancelAdd1" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
										<button id="submitchange" type="button" class="btn btn-warning" data-dismiss="modal">修改订单</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="modal fade" id="deleteBook" role="dialog">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal">&times;</button>
									<label class="modal-title">确认删除</label>
								</div>
								<div id="deleteModal" class="modal-body">
									<form method="get" role="form" class="form-horizontal">
										<div class="form-group">
											<label class="col-sm-12" style="text-align: center;">确认要删除订单吗？该操作不可逆</label>
										</div>
									</form>
									<form method="get" role="form" class="form-horizontal" id="subform_delete">
										<div class="form-group" style="display: none;">
											<label for="orderkey" class="col-sm-3 control-label label-name">订单号：</label>
											<div class="col-sm-8">
												<input class="form-control" type="text" name="orderkeydelete" id="orderkeydelete" required="true" />
											</div>
										</div>
									</form>
								</div>
								<div class="modal-footer">
									<div class="center-block" align="center">
										<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
										<button id="delete" type="button" class="btn btn-danger" data-dismiss="modal">删除</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<table id="books" class="table table-striped table-bordered row-border hover order-column" cellspacing="0" width="100%">
						<thead>
							<tr>
								<th>序号</th>
								<th>订单号</th>
								<th>商品名称</th>
								<th>商品类型</th>
								<th>出发地</th>
								<th>目的地</th>
								<th>价格</th>
								<th>订单状态</th>
								<th>要求送达时间</th>
								<th>重量</th>
								<th>发布者</th>
								<th>联系方式</th>
								<th>发布时间</th>
								<th>审核状态</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</section>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		var date_now = new Date();
		//得到当前年份
		var year = date_now.getFullYear();
		//得到当前月份
		//  1：js中获取Date中的month时，会比当前月份少一个月，所以这里需要先加一
		//  2: 判断当前月份是否小于10，如果小于，那么就在月份的前面加一个 '0' ， 如果大于，就显示当前月份
		var month = date_now.getMonth() + 1 < 10 ? "0" + (date_now.getMonth() + 1) : (date_now.getMonth() + 1);
		//得到当前日子（多少号）
		var date = date_now.getDate() < 10 ? "0" + date_now.getDate() : date_now.getDate();
		//设置input标签的min属性
		$("#Reqtime").attr("min", year + "-" + month + "-" + date);
		$("#Reqtime").attr("value", year + "-" + month + "-" + date);
		var arr = new Array(); //先声明一维
		function all() {
			$.ajax({
				type: "post",
				async: false,
				url: "http://localhost:8081/msg_orders.php",
				dataType: "json",
				success: function(result) {
					for (var i = 0; i < result.length; i++) { //一维长度为length
						arr[i] = new Array(); //再声明二维
						arr[i][0] = "";
						arr[i][1] = result[i].Orderkey;
						arr[i][2] = result[i].Cargoname;
						arr[i][3] = result[i].Category;
						arr[i][4] = result[i].Beginplace;
						arr[i][5] = result[i].Endplace;
						arr[i][6] = result[i].Pay;
						arr[i][7] = result[i].Status;
						arr[i][8] = result[i].Reqtime;
						arr[i][9] = result[i].Weight;
						arr[i][10] = result[i].Publisher;
						arr[i][11] = result[i].Numbers;
						arr[i][12] = result[i].Publishtime;
						if (result[i].Audit == 1)
							arr[i][13] = "审核通过";
						else if(result[i].Audit == 0)
							arr[i][13] = "待审核";
						else
							arr[i][13] = "建议修改";
					}
				}
			})
			return;
		}
	</script>
	<script>
		all();
		var data = arr;
		var table;
		$(function() {
			var table = $('#books').DataTable({
				data: data,
				"pagingType": "full_numbers",
				"bSort": true,
				"language": {
					"sProcessing": "处理中...",
					"sLengthMenu": "显示 _MENU_ 项结果",
					"sZeroRecords": "没有匹配结果",
					"sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
					"sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
					"sInfoFiltered": "(由 _MAX_ 项结果过滤)",
					"sInfoPostFix": "",
					"sSearch": "搜索:",
					"sUrl": "",
					"sEmptyTable": "表中数据为空",
					"sLoadingRecords": "载入中...",
					"sInfoThousands": ",",
					"oPaginate": {
						"sFirst": "首页",
						"sPrevious": "上页",
						"sNext": "下页",
						"sLast": "末页"
					},
					"oAria": {
						"sSortAscending": ": 以升序排列此列",
						"sSortDescending": ": 以降序排列此列"
					}
				},
				"columnDefs": [{
					"searchable": false,
					"orderable": true,
					"targets": 0
				}, {
					"targets": [1, 7, 9, 10, 11],
					"visible": false,
				}, ],
			});
			table.on('order.dt search.dt', function() {
				table.column(0, {
					search: 'applied',
					order: 'applied'
				}).nodes().each(function(cell, i) {
					cell.innerHTML = i + 1;
				});
			}).draw();
			$('#books tbody').on('click', 'tr', function() {
				if ($(this).hasClass('selected')) {
					$(this).removeClass('selected');
				} else {
					table.$('tr.selected').removeClass('selected');
					$(this).addClass('selected');
				}
			});
			$("#cancelAdd").on('click', function() {
				$("#addBookModal").find('input').val('')
			})
			$("#submitorder").on('click', function() {
				if ($.trim($('#Cargoname').val()).length == 0)
					alert('货物名称没有输入！');
				else if (isNaN($("#Pay").val()) || $("#Pay").val() <= 0) {
					alert("请输入正确的金额（大于0的数字）");
				} else if (!$('#Reqtime').val()) {
					alert("请输入正确的送达时间");
				} else if (isNaN($("#Weight").val()) || $("#Weight").val() <= 0) {
					alert("请输入正确的货物重量");
				} else {
					$.ajax({
						type: "post",
						async: false,
						url: "http://localhost:8081/addorder.php",
						data: $("#subform_order").serialize() + '&' + 'Numbers=' + $.cookie('user') + '&' + 'Publishtime=' + year +
							"-" + month + "-" + date,
						dataType: "json",
						success: function(result) {
							alert("订单提交成功，我们将在3个工作日内对您的订单进行审核\n注意：审核通过的订单不可更改！");
						}
					})
					location.reload();
					$("#addBookModal").find('input').val('')
				}
			})
			$("#btn_add").click(function() {
				$("#addBook").modal()
			});
			$('#btn_edit').click(function() {
				if (table.rows('.selected').data().length) {
					$("#editBookInfo").modal()
					var rowData = table.rows('.selected').data()[0];
					$("#Orderkey").val(rowData[1]);
					$("#editCargoname").val(rowData[2]);
					var s = document.getElementById("editgoodstype");
					var ops = s.options;
					for (var j = 0; j < ops.length; j++) {
						var tempValue = ops[j].value;
						if (tempValue == rowData[3])
							ops[j].selected = true;
					}
					var s = document.getElementById("editstartplace");
					var ops = s.options;
					for (var j = 0; j < ops.length; j++) {
						var tempValue = ops[j].value;
						if (tempValue == rowData[4])
							ops[j].selected = true;
					}
					var s = document.getElementById("editdestination");
					var ops = s.options;
					for (var j = 0; j < ops.length; j++) {
						var tempValue = ops[j].value;
						if (tempValue == rowData[5])
							ops[j].selected = true;
					}
					$("#editPay").val(rowData[6]);
					$("#editReqtime").val(rowData[8]);
					$("#editWeight").val(rowData[9]);
					$("#editaduit").val(rowData[13]);
				} else {
					alert('请选择项目');
				}
			});
			$("#submitchange").click(function() {
				if ($("#editaduit").val() == "审核通过")
					alert('已通过审核的订单不可修改！若信息有误请删除订单');
				else if ($.trim($('#editCargoname').val()).length == 0)
					alert('货物名称没有输入！');
				else if (isNaN($("#editPay").val()) || $("#editPay").val() <= 0) {
					alert("请输入正确的金额（大于0的数字）");
				} else if (!$('#editReqtime').val()) {
					alert("请输入正确的送达时间");
				} else if (isNaN($("#editWeight").val()) || $("#editWeight").val() <= 0) {
					alert("请输入正确的货物重量");
				} else {
					$.ajax({
						type: "post",
						async: false,
						url: "http://localhost:8081/changeorder.php",
						data: $("#subform_change").serialize(),
						dataType: "json",
						success: function(result) {
							alert("订单更改成功！");
						}
					});
					location.reload();
				}
			});

			$("#cancelEdit").click(function() {
				$("#editBookModal").find('input').val('')
			})
			$('#btn_delete').click(function() {
				if (table.rows('.selected').data().length) {
					$("#deleteBook").modal()
					var rowData = table.rows('.selected').data()[0];
					var inputs = $("#deleteModal").find('input')
					$(inputs[0]).val(rowData[1])
				} else {
					alert('请选择项目');
				}
			});
			$('#delete').click(function() {
				$.ajax({
					type: "post",
					async: false,
					url: "http://localhost:8081/orderkeydelete.php",
					data: $("#subform_delete").serialize(),
					dataType: "json",
					success: function(result) {
						alert("订单删除成功！");
					}
				});
				table.row('.selected').remove().draw(false);
			});
			$.fn.dataTable.ext.search.push(
				function(settings, data, dataIndex) {
					if (data[11] != $.cookie('user')) {
						return false;
					}
					if (data[7] != '等待接单') {
						return false;
					}
					return true;
				}
			);
			table.draw();
		})
	</script>

</html>
